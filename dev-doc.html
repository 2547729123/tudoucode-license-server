<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ’ä»¶æˆæƒç®¡ç† - å¼€å‘æ–‡æ¡£</title>
<style>
  body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; line-height:1.6; padding: 20px; background:#f9f9f9; }
  h1, h2, h3 { color: #2c3e50; }
  pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; }
  code { font-family: Consolas, Monaco, monospace; }
  table { border-collapse: collapse; width: 100%; max-width: 900px; margin-bottom: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; }
  th { background-color: #f0f0f0; text-align: left; }
  .section { margin-bottom: 40px; }
</style>
</head>
<body>

<h1>æ’ä»¶æˆæƒç®¡ç†ç³»ç»Ÿå¼€å‘æ–‡æ¡£</h1>
<p>æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†ç”¨äºç®¡ç†ç é“ƒè–¯ä½œè€…æ’ä»¶æˆæƒæ¿€æ´»çš„PHPä»£ç å®ç°ã€‚æ–¹ä¾¿å¼€å‘è€…ç†è§£å’Œç»´æŠ¤æˆæƒç›¸å…³åŠŸèƒ½ã€‚</p>

<div class="section">
  <h2>1. è·å–æ‰€æœ‰ç é“ƒè–¯æ’ä»¶</h2>
  <p>å‡½æ•° <code>get_all_mdl_plugins()</code> ä¼šéå†WordPresså·²å®‰è£…æ’ä»¶ï¼Œç­›é€‰ä½œè€…ä¸ºâ€œç é“ƒè–¯â€çš„æ’ä»¶ï¼Œè¿”å›æ’ä»¶IDå’Œåç§°åˆ—è¡¨ã€‚</p>
  <pre><code>&lt;?php
function get_all_mdl_plugins() {
    require_once ABSPATH . 'wp-admin/includes/plugin.php';
    $all_plugins = get_plugins();
    $plugin_list = [];

    foreach ($all_plugins as $plugin_path =&gt; $plugin_data) {
        if (isset($plugin_data['Author']) &amp;&amp; $plugin_data['Author'] === 'ç é“ƒè–¯') {
            $plugin_slug = dirname($plugin_path);
            $plugin_list[$plugin_slug] = $plugin_data['Name'];
        }
    }
    return $plugin_list;
}
?&gt;</code></pre>
</div>

<div class="section">
  <h2>2. åå°èœå•æ·»åŠ </h2>
  <p>åˆ©ç”¨ <code>add_action('admin_menu')</code> æ·»åŠ ä¸€ä¸ªæ’ä»¶æˆæƒç®¡ç†é¡µé¢èœå•é¡¹ï¼Œèœå•æ ‡é¢˜â€œæ’ä»¶æˆæƒç®¡ç†â€ï¼Œé¡µé¢æ ‡é¢˜â€œæ’ä»¶æˆæƒæ¿€æ´»â€ã€‚</p>
  <pre><code>add_action('admin_menu', function() {
    add_options_page('æ’ä»¶æˆæƒæ¿€æ´»', 'æ’ä»¶æˆæƒç®¡ç†', 'manage_options', 'mdl-plugin-license', function() {
        mdl_plugin_license_page();
    });
});</code></pre>
</div>

<div class="section">
  <h2>3. æˆæƒç®¡ç†é¡µé¢å†…å®¹</h2>
  <p>å‡½æ•° <code>mdl_plugin_license_page()</code> æ¸²æŸ“ç®¡ç†é¡µé¢ï¼Œåˆ—å‡ºæ‰€æœ‰æ’ä»¶åŠå…¶æˆæƒç è¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºç»‘å®šåŸŸåå’ŒæˆæƒçŠ¶æ€ï¼Œå¹¶ç”¨AJAXå®ç°ä¿å­˜æˆæƒç ã€‚</p>
  <pre><code>function mdl_plugin_license_page() {
    if (!current_user_can('manage_options')) return;

    $plugins = get_all_mdl_plugins();
    $all_licenses = get_option('my_plugin_licenses', []);
    $current_domain = preg_replace('/:\d+$/', '', $_SERVER['HTTP_HOST']);

    ?&gt;
    &lt;div class="wrap"&gt;
        &lt;h1&gt;æ’ä»¶æˆæƒæ¿€æ´» - ç é“ƒè–¯æ‰€æœ‰æ’ä»¶&lt;/h1&gt;
        &lt;div id="mdl-plugin-notice"&gt;&lt;/div&gt;
        &lt;form id="mdl-plugin-license-form" method="post" action=""&gt;
            &lt;?php wp_nonce_field('mdl_plugin_license_action', 'mdl_plugin_license_nonce'); ?&gt;
            &lt;table class="form-table" style="max-width:600px;"&gt;
                &lt;thead&gt;
                    &lt;tr&gt;
                        &lt;th style="width:180px;"&gt;æ’ä»¶åç§°&lt;/th&gt;
                        &lt;th style="width:300px;"&gt;æˆæƒç &lt;/th&gt;
                        &lt;th&gt;æ“ä½œ&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody&gt;
                &lt;?php foreach ($plugins as $plugin_id =&gt; $plugin_name): 
                    $license_data = $all_licenses[$plugin_id] ?? ['license_key' =&gt; '', 'domain' =&gt; ''];
                    $license_key = $license_data['license_key'] ?? '';
                    $bound_domain = !empty($license_data['domain']) ? $license_data['domain'] : $current_domain;

                    $is_authorized = false;
                    if (function_exists('my_plugin_check_pro_license')) {
                        $is_authorized = my_plugin_check_pro_license($plugin_id);
                    }
                    $status_text = $is_authorized ? 'âœ… å·²æˆæƒ' : 'âŒ æœªæˆæƒ';
                    $status_color = $is_authorized ? 'green' : 'red';
                ?&gt;
                    &lt;tr&gt;
                        &lt;td&gt;&lt;strong&gt;&lt;?php echo esc_html($plugin_name); ?&gt;&lt;/strong&gt;&lt;/td&gt;
                        &lt;td&gt;
                            &lt;input type="text" name="license_keys[&lt;?php echo esc_attr($plugin_id); ?&gt;]" value="&lt;?php echo esc_attr($license_key); ?&gt;" style="width: 100%;" required&gt;
                            &lt;br&gt;
                            &lt;small&gt;
                                å·²ç»‘å®šåŸŸåï¼š&lt;code&gt;&lt;?php echo esc_html($bound_domain); ?&gt;&lt;/code&gt;&lt;br&gt;
                                æˆæƒçŠ¶æ€ï¼š&lt;span style="color: &lt;?php echo $status_color; ?&gt;"&gt;&lt;?php echo $status_text; ?&gt;&lt;/span&gt;
                            &lt;/small&gt;
                        &lt;/td&gt;
                        &lt;td&gt;
                            &lt;button type="submit" name="generate_license" value="&lt;?php echo esc_attr($plugin_id); ?&gt;" class="button"&gt;ä¿å­˜æˆæƒ&lt;/button&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                &lt;?php endforeach; ?&gt;
                &lt;/tbody&gt;
            &lt;/table&gt;
        &lt;/form&gt;
    &lt;/div&gt;

    &lt;script&gt;
    (function($){
        $('#mdl-plugin-license-form').on('submit', function(e){
            e.preventDefault();

            var $btn = $(document.activeElement);
            var pluginId = $btn.val();
            var licenseKey = $('input[name="license_keys[' + pluginId + ']"]').val();
            var nonce = $('input[name="mdl_plugin_license_nonce"]').val();

            $('#mdl-plugin-notice').html('');

            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'mdl_plugin_save_license',
                    license_key: licenseKey,
                    plugin_id: pluginId,
                    _wpnonce: nonce
                },
                success: function(response) {
                    if(response.success){
                        if (response.data.redirect) {
                            window.location.href = response.data.redirect;
                        } else {
                            location.reload();
                        }
                    } else {
                        $('#mdl-plugin-notice').html('&lt;div class="notice notice-error"&gt;&lt;p&gt;' + response.data.message + '&lt;/p&gt;&lt;/div&gt;');
                    }
                },
                error: function(){
                    $('#mdl-plugin-notice').html('&lt;div class="notice notice-error"&gt;&lt;p&gt;è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚&lt;/p&gt;&lt;/div&gt;');
                }
            });
        });
    })(jQuery);
    &lt;/script&gt;
    &lt;?php
}</code></pre>
</div>

<div class="section">
  <h2>4. AJAXä¿å­˜æˆæƒç å¤„ç†</h2>
  <p>é€šè¿‡AJAXæ¥å£ <code>mdl_plugin_save_license_callback()</code> éªŒè¯å®‰å…¨ã€è°ƒç”¨è¿œç¨‹æ¥å£æ ¡éªŒæˆæƒç ï¼Œå¹¶ä¿å­˜åˆ°æ•°æ®åº“ã€‚</p>
  <pre><code>add_action('wp_ajax_mdl_plugin_save_license', function() {
    $plugin_id = sanitize_text_field($_POST['plugin_id'] ?? '');
    mdl_plugin_save_license_callback($plugin_id);
});

function mdl_plugin_save_license_callback($plugin_id) {
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' =&gt; 'æ— æƒé™æ“ä½œ']);
    }

    if (empty($_POST['_wpnonce']) || !wp_verify_nonce($_POST['_wpnonce'], 'mdl_plugin_license_action')) {
        wp_send_json_error(['message' =&gt; 'å®‰å…¨éªŒè¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•']);
    }

    if (empty($plugin_id)) {
        wp_send_json_error(['message' =&gt; 'æ’ä»¶IDä¸èƒ½ä¸ºç©º']);
    }

    $license_key = sanitize_text_field($_POST['license_key'] ?? '');
    if (empty($license_key)) {
        wp_send_json_error(['message' =&gt; 'æˆæƒç ä¸èƒ½ä¸ºç©º']);
    }

    $current_domain = preg_replace('/:\d+$/', '', $_SERVER['HTTP_HOST']);

    $response = wp_remote_post('https://www.tudoucode.cn/wp-json/tudoucode-license/v1/verify', [
        'body' =&gt; json_encode([
            'license_key' =&gt; $license_key,
            'domain' =&gt; $current_domain,
            'plugin_id' =&gt; $plugin_id,
        ]),
        'headers' =&gt; ['Content-Type' =&gt; 'application/json'],
        'timeout' =&gt; 10,
    ]);

    if (is_wp_error($response)) {
        wp_send_json_error(['message' =&gt; 'æ— æ³•è¿æ¥æˆæƒæœåŠ¡å™¨ï¼Œè¯·ç¨åé‡è¯•']);
    }

    $code = wp_remote_retrieve_response_code($response);
    $body = wp_remote_retrieve_body($response);
    $data = json_decode($body, true);

    if ($code === 200 && !empty($data['success'])) {
        $all_licenses = get_option('my_plugin_licenses', []);
        $all_licenses[$plugin_id] = [
            'license_key' =&gt; $license_key,
            'domain' =&gt; $current_domain,
        ];
        update_option('my_plugin_licenses', $all_licenses);

        wp_send_json_success([
            'message' =&gt; 'æˆæƒéªŒè¯å¹¶ç»‘å®šåŸŸåæˆåŠŸï¼æ’ä»¶ProåŠŸèƒ½å·²æ¿€æ´»ã€‚',
            'domain' =&gt; $current_domain,
            'redirect' =&gt; admin_url('options-general.php?page=mdl-plugin-license&amp;mdl_license_success=1'),
        ]);
    } else {
        $msg = $data['message'] ?? 'æœªçŸ¥é”™è¯¯';
        wp_send_json_error(['message' =&gt; 'æˆæƒéªŒè¯å¤±è´¥ï¼š' . $msg . 'ã€‚è¯·å‰å¾€ &lt;a href="https://www.tudoucode.cn/user" target="_blank"&gt;æˆæƒç®¡ç†é¡µé¢&lt;/a&gt; è·å–æœ‰æ•ˆæˆæƒç ã€‚']);
    }
}
</code></pre>
</div>

<div class="section">
  <h2>5. æˆæƒæ£€æµ‹å‡½æ•°</h2>
  <p>å‡½æ•° <code>my_plugin_check_pro_license($plugin_id)</code> ç”¨äºç¼“å­˜æ£€æµ‹æˆæƒçŠ¶æ€ï¼Œå‡å°‘é¢‘ç¹è¯·æ±‚ã€‚</p>
  <pre><code>function my_plugin_check_pro_license($plugin_id) {
    $all_licenses = get_option('my_plugin_licenses', []);
    if (!isset($all_licenses[$plugin_id])) return false;

    $license_key = $all_licenses[$plugin_id]['license_key'] ?? '';
    $domain = $all_licenses[$plugin_id]['domain'] ?? '';

    if (empty($domain)) {
        $domain = preg_replace('/:\d+$/', '', $_SERVER['HTTP_HOST'] ?? '');
    }

    if (empty($license_key) || empty($domain)) {
        return false;
    }

    $cache_key = 'my_plugin_license_check_' . md5($license_key . '_' . $domain . '_' . $plugin_id);
    $cached_result = get_transient($cache_key);
    if ($cached_result !== false) return $cached_result;

    $url = 'https://www.tudoucode.cn/wp-json/tudoucode-license/v1/verify';
    $response = wp_remote_post($url, [
        'body' =&gt; json_encode([
            'license_key' =&gt; $license_key,
            'domain' =&gt; $domain,
            'plugin_id' =&gt; $plugin_id,
        ]),
        'headers' =&gt; [
            'Content-Type' =&gt; 'application/json',
        ],
        'timeout' =&gt; 10,
    ]);

    if (is_wp_error($response)) return false;

    $body = wp_remote_retrieve_body($response);
    $data = json_decode($body, true);
    $success = !empty($data['success']);

    set_transient($cache_key, $success, 10 * MINUTE_IN_SECONDS);
    return $success;
}</code></pre>
</div>

<div class="section">
  <h2>6. åå°æˆæƒæç¤º</h2>
  <p>åå°åŠ è½½æ—¶ä¼šæ£€æµ‹æœªæˆæƒæ’ä»¶å¹¶æ˜¾ç¤ºè­¦å‘Šé€šçŸ¥ï¼ŒæˆæƒæˆåŠŸæ—¶æ˜¾ç¤ºæˆåŠŸæç¤ºã€‚</p>
  <pre><code>add_action('admin_init', function() {
    if (!current_user_can('manage_options')) return;
    if (isset($_GET['mdl_license_success']) &amp;&amp; $_GET['mdl_license_success'] === '1') {
        set_transient('mdl_license_success_notice', true, 60);
    }
});

add_action('admin_notices', function() {
    if (!current_user_can('manage_options')) return;

    $plugins = get_all_mdl_plugins();
    $all_licenses = get_option('my_plugin_licenses', []);
    $unauthorized_plugins = [];

    foreach ($plugins as $plugin_id =&gt; $plugin_name) {
        if (!my_plugin_check_pro_license($plugin_id)) {
            $unauthorized_plugins[] = $plugin_name;
        }
    }

    if (!empty($unauthorized_plugins)) {
        $plugin_list = implode('ã€', array_map('esc_html', $unauthorized_plugins));
        $settings_url = admin_url('options-general.php?page=mdl-plugin-license');
        echo '&lt;div class="notice notice-error"&gt;&lt;p&gt;';
        echo 'âš ï¸ &lt;strong&gt;æˆæƒæç¤ºï¼š&lt;/strong&gt;ä»¥ä¸‹æ’ä»¶å°šæœªæˆæƒï¼š' . $plugin_list . 'ã€‚';
        echo 'è¯·å°½å¿«å‰å¾€ &lt;a href="' . esc_url($settings_url) . '"&gt;æˆæƒç®¡ç†é¡µé¢&lt;/a&gt; ç»‘å®šæˆæƒç ã€‚';
        echo '&lt;/p&gt;&lt;/div&gt;';
    }

    if (get_transient('mdl_license_success_notice')) {
        delete_transient('mdl_license_success_notice');
        echo '&lt;div class="notice notice-success"&gt;&lt;p&gt;ğŸ‰ æˆæƒæ¿€æ´»æˆåŠŸï¼æ’ä»¶ProåŠŸèƒ½å·²å¼€å¯ã€‚&lt;/p&gt;&lt;/div&gt;';
    }
});
</code></pre>
</div>

</body>
</html>
